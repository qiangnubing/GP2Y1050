#include "bsp_gp2y1050.h"

/*
需要移植的代码：
*/
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/*
 ************************************************************
 *  名称：	BSP_GP2Y1050_Init_Port()
 *  功能：	接口函数-PM2.5传感器接收数据初始化
 *	输入：  无
 *	输出：  无
 ************************************************************
*/
void BSP_GP2Y1050_Init_Port(void)
{
	gp2y1050.status = 0;
	gp2y1050.vout = 0;
	gp2y1050.vref = 0;
	gp2y1050.data_p= 0;
	
	HAL_USART3_Init(2400);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

GP2Y1050_Type gp2y1050;

/*
 ************************************************************
 *  名称：	BSP_GP2Y1050_GetData()
 *  功能：	GP2Y1050获取数据
 *	输入：  无
 *	输出：  TRUE-成功    FALSE-失败
 ************************************************************
*/
float BSP_GP2Y1050_GetData(void)
{
	return gp2y1050.vout;
}

/*
 ************************************************************
 *  名称：	BSP_GP2Y1050_RecvIRQ()
 *  功能：  GP2Y1050串口接收函数（需要挂在串口接收中断函数里）
 *	输入：  无
 *	输出：  无
 ************************************************************
*/
void BSP_GP2Y1050_RecvIRQ(u8 data)
{
	static u8 i=0;
	static u32 temp=0;
	
	if(gp2y1050.status == 0)	//开始接收数据
	{
		if(data == 0xAA)
		{
			gp2y1050.status = 1;
			gp2y1050.data_p = 0;
		}
	}
	else if(gp2y1050.status == 1)		//接收到起始位
	{
		gp2y1050.data[gp2y1050.data_p++] = data;
		
		if(gp2y1050.data_p == 6)
		{
			if(gp2y1050.data[5] == 0xFF)
			{
				u8 check = gp2y1050.data[0]+gp2y1050.data[1]+gp2y1050.data[2]+gp2y1050.data[3];	//判断校验和
				if(check == gp2y1050.data[4])
				{
					temp += (((u16)gp2y1050.data[0]<<8)+gp2y1050.data[1]);
					i++;
					if(i >= 30)
					{
						gp2y1050.vout = temp/30;
						i=0;
						temp=0;
					}
//					gp2y1050.vout = ((u16)gp2y1050.data[0]<<8)+gp2y1050.data[1];
					gp2y1050.vref = ((u16)gp2y1050.data[2]<<8)+gp2y1050.data[3];
					gp2y1050.status = 0;
				}
				else	//校验和出错
				{
					gp2y1050.status = 0;	//重新接收
				}
			}
			else	//接收位置出错
			{
				gp2y1050.status = 0;
			}
		}
	}
	
}
